Building LAMMPS 13Feb2024 on ARCHER2 (CPE 22.12)
================================================

These instructions are for building LAMMPS version 13Feb2024, also known as 07Feb2024 update 1, on ARCHER2 using the Cray clang compilers 15.0.2 // cpe 22.12 with support for VTK files.

Path setup
-----------

```bash
# base-path for download and source files
export DWNLD_DIR="/work/y07/shared/apps/dev/lammps/13Feb2024-src"
export INSTALL_DIR="/work/y07/shared/apps/core/lammps/13Feb2024"
export LAMMPS_DWNLD=${DWNLD_DIR}/lammps-2024-02-13
export LAMMPS_BUILD=${LAMMPS_DWNLD}/build
export LAMMPS_INSTALL=${INSTALL_DIR}/lammps
export VTK_DWNLD=${DWNLD_DIR}/vtk
export VTK_BUILD=${VTK_DWNLD}/build
export VTK_INSTALL=${INSTALL_DIR}/vtk
```


Setup your environment
----------------------

Load the correct modules:

```bash
module load cpe/22.12
module load cray-fftw/3.3.10.3
module load cmake/3.21.3
module load cray-python

export LD_LIBRARY_PATH=$CRAY_LD_LIBRARY_PATH:$LD_LIBRARY_PATH

# create and source a virtual environment
python -m venv --system-site-packages ${LAMMPS_INSTALL}/venv/lammps-python-13-Feb-2024
source ${LAMMPS_INSTALL}/venv/lammps-python-13-Feb-2024/bin/activate
```

Download and compile the VTK library
------------------------------------

```bash
mkdir -p ${VTK_DWNLD}
cd ${VTK_DWNLD}
wget https://vtk.org/files/release/9.5/VTK-9.5.2.tar.gz
tar -xvf VTK-9.5.2.tar.gz
mv VTK-9.5.2 source
mkdir -p ${VTK_BUILD}
cd ${VTK_BUILD}
cmake -DCMAKE_INSTALL_PREFIX=${VTK_INSTALL} -DVTK_USE_MPI:BOOL=ON -DVTK_SMP_IMPLEMENTATION_TYPE:STRING=OpenMP -DCMAKE_BUILD_TYPE:STRING=Release ${VTK_DWNLD}/source 
cmake --build . -j8
cmake --install .
```

Download LAMMPS
---------------

Clone the latest stable version of LAMMPS from the GitHub repository:

```bash
cd $DWNLD_DIR
git clone --depth=1 --branch patch_7Feb2024_update1 https://github.com/lammps/lammps.git ${LAMMPS_DWNLD}
```


Regular MPI executable and python wrappers
------------------------------------------

Create and go into a build directory:

```bash
mkdir -p ${LAMMPS_BUILD}
cd ${LAMMPS_BUILD}
```

Build using:

```bash
cmake -C ../cmake/presets/most.cmake                \
      -D BUILD_MPI=on                               \
      -D BUILD_SHARED_LIBS=yes                      \
      -D CMAKE_CXX_COMPILER=CC                      \
      -D CMAKE_CXX_FLAGS="-O2"                      \
      -D CMAKE_INSTALL_PREFIX=${LAMMPS_INSTALL}     \
      -D FFT=FFTW3                                  \
      -D FFTW3_INCLUDE_DIR=${FFTW_INC}              \
      -D FFTW3_LIBRARY=${FFTW_DIR}/libfftw3_mpi.so  \
      -D PKG_MPIIO=yes                              \
      -D PKG_VTK=yes                                \
      -D VTK_DIR=${VTK_INSTALL}/lib64/cmake/vtk-9.5             \
      ../cmake/

make -j 8
make install
make install-python
```

To run LAMMPS from python
-------------------------

`LD_PRELOAD` needs to be modified (this is done in the module file, but
if running the text below without loading a module, it needs to be done
explicitly):

```bash
export LD_PRELOAD=/opt/cray/pe/lib64/libsci_cray_mp.so.5:$LD_PRELOAD
```

Testing LAMMPS from python
--------------------------

```bash
python -i
>>> import lammps
>>> lmp = lammps.lammps()
LAMMPS (15 Aug 2023 - Update 2)
OMP_NUM_THREADS environment is not set. Defaulting to 1 thread. (src/comm.cpp:98)
  using 1 OpenMP thread(s) per MPI task
```
